const DB={STORAGE_KEY:'brainrotflip_db',SHARED_KEY:'brainrotflip_shared',data:null,shared:null,async init(){const saved=localStorage.getItem(this.STORAGE_KEY);if(saved){this.data=JSON.parse(saved)}else{this.data=this.getDefaultData()}const sharedData=localStorage.getItem(this.SHARED_KEY);if(sharedData){this.shared=JSON.parse(sharedData)}else{this.shared={coinflips:[],chat:[],race:{participants:{}}};this.saveShared()}this.save();return this.data},save(){localStorage.setItem(this.STORAGE_KEY,JSON.stringify(this.data))},saveShared(){localStorage.setItem(this.SHARED_KEY,JSON.stringify(this.shared))},getDefaultData(){return{users:{},items:{skibidi_toilet:{id:"skibidi_toilet",name:"Skibidi Toilet",value:100,icon:"Item_Assets/skibidi_toilet.png"},cameraman:{id:"cameraman",name:"Cameraman",value:250,icon:"Item_Assets/cameraman.png"},tv_man:{id:"tv_man",name:"TV Man",value:500,icon:"Item_Assets/tv_man.png"},speakerman:{id:"speakerman",name:"Speakerman",value:750,icon:"Item_Assets/speakerman.png"},gman:{id:"gman",name:"G-Man",value:1000,icon:"Item_Assets/gman.png"},titan_cameraman:{id:"titan_cameraman",name:"Titan Cameraman",value:2500,icon:"Item_Assets/titan_cameraman.png"},titan_speakerman:{id:"titan_speakerman",name:"Titan Speakerman",value:2500,icon:"Item_Assets/titan_speakerman.png"},titan_tvman:{id:"titan_tvman",name:"Titan TV Man",value:3000,icon:"Item_Assets/titan_tvman.png"},chill_guy:{id:"chill_guy",name:"Chill Guy",value:150,icon:"Item_Assets/chill_guy.png"},sigma:{id:"sigma",name:"Sigma",value:300,icon:"Item_Assets/sigma.png"},ohio_boss:{id:"ohio_boss",name:"Ohio Boss",value:10000,icon:"Item_Assets/ohio_boss.png"},rizz_god:{id:"rizz_god",name:"Rizz God",value:7500,icon:"Item_Assets/rizz_god.png"},gyatt:{id:"gyatt",name:"Gyatt",value:200,icon:"Item_Assets/gyatt.png"},kai_cenat:{id:"kai_cenat",name:"Kai Cenat",value:5000,icon:"Item_Assets/kai_cenat.png"},ishowspeed:{id:"ishowspeed",name:"IShowSpeed",value:6000,icon:"Item_Assets/ishowspeed.png"}}}},getUser(username){return this.data.users[username]||null},createUser(username,robloxId){const user={id:'usr_'+Date.now(),username,robloxId,verified:true,isAdmin:username==='DimaWarm_BlueHive',level:1,stats:{wagered:0,won:0,lost:0,gamesPlayed:0,gamesWon:0},inventory:[],avatar:`https://www.roblox.com/headshot-thumbnail/image?userId=${robloxId}&width=150&height=150&format=png`,createdAt:new Date().toISOString()};this.data.users[username]=user;this.save();return user},addItemToUser(username,itemId,qty=1){const user=this.data.users[username];const item=this.data.items[itemId];if(!user||!item)return false;for(let i=0;i<qty;i++){user.inventory.push({...item,uniqueId:'inv_'+Date.now()+'_'+Math.random().toString(36).substr(2,9)})}this.save();return true},removeItemsFromUser(username,uniqueIds){const user=this.data.users[username];if(!user)return false;user.inventory=user.inventory.filter(item=>!uniqueIds.includes(item.uniqueId));this.save();return true},getUserBalance(username){const user=this.data.users[username];if(!user)return 0;return user.inventory.reduce((sum,item)=>sum+item.value,0)},createCoinflip(creatorUsername,items,side){const creator=this.data.users[creatorUsername];if(!creator)return null;const totalValue=items.reduce((sum,item)=>sum+item.value,0);const coinflip={id:'cf_'+Date.now(),creator:creatorUsername,creatorAvatar:creator.avatar,creatorItems:items,creatorSide:side,opponent:null,opponentAvatar:null,opponentItems:[],totalValue,status:'waiting',winner:null,createdAt:new Date().toISOString()};this.removeItemsFromUser(creatorUsername,items.map(i=>i.uniqueId));this.shared.coinflips.push(coinflip);this.saveShared();return coinflip},getCoinflip(id){return this.shared.coinflips.find(cf=>cf.id===id)},getActiveCoinflips(){return this.shared.coinflips.filter(cf=>cf.status==='waiting')},getAllCoinflips(){return this.shared.coinflips},joinCoinflip(coinflipId,opponentUsername,items){const cf=this.getCoinflip(coinflipId);const opponent=this.data.users[opponentUsername];if(!cf||!opponent||cf.status!=='waiting')return null;cf.opponent=opponentUsername;cf.opponentAvatar=opponent.avatar;cf.opponentItems=items;cf.status='playing';this.removeItemsFromUser(opponentUsername,items.map(i=>i.uniqueId));this.saveShared();return cf},finishCoinflip(coinflipId,winnerSide){const cf=this.getCoinflip(coinflipId);if(!cf||cf.status!=='playing')return null;const winner=winnerSide===cf.creatorSide?cf.creator:cf.opponent;const loser=winner===cf.creator?cf.opponent:cf.creator;cf.winner=winner;cf.winnerSide=winnerSide;cf.status='finished';cf.finishedAt=new Date().toISOString();const allItems=[...cf.creatorItems,...cf.opponentItems];const winnerUser=this.data.users[winner];if(winnerUser)winnerUser.inventory.push(...allItems);const totalPot=cf.totalValue*2;if(this.data.users[winner]){this.data.users[winner].stats.won+=totalPot;this.data.users[winner].stats.wagered+=cf.totalValue;this.data.users[winner].stats.gamesPlayed++;this.data.users[winner].stats.gamesWon++}if(this.data.users[loser]){this.data.users[loser].stats.lost+=cf.totalValue;this.data.users[loser].stats.wagered+=cf.totalValue;this.data.users[loser].stats.gamesPlayed++}this.shared.coinflips=this.shared.coinflips.filter(c=>c.id!==coinflipId);this.save();this.saveShared();return cf},addChatMessage(username,message){const user=this.data.users[username];if(!user)return null;const msg={id:'msg_'+Date.now(),username,avatar:user.avatar,isAdmin:user.isAdmin,message:message.substring(0,200),timestamp:new Date().toISOString()};this.shared.chat.push(msg);if(this.shared.chat.length>100)this.shared.chat=this.shared.chat.slice(-100);this.saveShared();return msg},getChatMessages(limit=50){return this.shared.chat.slice(-limit)},getLeaderboard(type='wagered',limit=20){return Object.values(this.data.users).sort((a,b)=>(b.stats[type]||0)-(a.stats[type]||0)).slice(0,limit)},getAllItems(){return Object.values(this.data.items)},getAllUsers(){return Object.values(this.data.users)}};window.DB=DB;